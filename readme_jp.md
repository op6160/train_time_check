# 列車運行情報通知

このプロジェクトは、JRセントラルのウェブサイトから列車の遅延や運休情報を確認し、指定されたDiscordチャンネルに通知を送るシステムです。<br>
公式のプッシュ通知サービスがないため、毎回ウェブサイトを確認したり、駅に着いてから遅延に気づくという通勤時の手間を解決するために開発されました。

このプロジェクトは2つの自動化方法をサポートしています。<br>
1. Cron自動化: 安定した定期的/周期的実行のための推奨方法です。`ubuntu/`ディレクトリのスクリプトを使用して設定できます。<br>
サーバーまたはデバイスが必要です。
> 動作確認済みOS: `mac 26.2` , `ubuntu 22.04`
2. GitHub Actions: 別途サーバー環境がないユーザーのための代替手段です。`.github/workflows/`内の`schedule_*.yml`ファイルの`cron`部分のコメントを解除して有効化でき、リポジトリコードの更新時に自動的なデバッグ用途としても使用されます。

## 主な機能

-   **リアルタイム運行情報確認**: JR中央線ウェブサイトの情報をスクレイピングして現在の運行状況を確認します。
-   **遅延情報パーシング**: 列車の遅延発生時、詳細な遅延情報（影響区間、時間など）と各列車の位置情報を抽出します。
-   **多言語対応**: 確認された情報を韓国語、日本語、英語で加工して提供します。
-   **Discord通知**: 書式が適用された運行情報を指定されたDiscordチャンネルにウェブフックを通じて送信します。
-   **自動実行**: GitHub ActionsまたはサーバーのCronジョブを介して、特定の時間（例：通勤時間）に自動的に実行するように設定できます。
-   **ターゲティング機能**: 特定の駅と移動方向（上り/下り）を基準に、関連する列車情報のみをフィルタリングして通知を送信できます。
-   **エラー報告**: 新しいエラーが発生した場合、GitHubにissueを自動的に登録します。

## 動作原理

1.  **データ収集 (Web Scraping)**:
    -   `requests`または`selenium`を使用して、JR中央線の運行情報ページのHTMLを取得します。
    -   (**`src/parse/rate_train_info.py`**)

2.  **情報パーシングと分析**:
    -   取得したHTMLを`BeautifulSoup`を使用してパーシングし、全体の運行状況が「正常運転」か確認します。
    -   遅延が発生した場合、お知らせ全文とともに、遅延した各列車の種類、目的地、現在位置、遅延時間などの詳細情報を抽出します。
    -   (**`src/parse/train_info.py`**, **`src/parse/rate_train_info.py`**)

3.  **データ処理と加工**:
    -   抽出された生データをフィルタリング（特定の駅、方向基準）し、多言語（ko, en, ja）メッセージに変換します。
    -   (**`src/api.py`**, **`src/get_contents.py`**)

4.  **通知送信**:
    -   加工されたメッセージをDiscordウェブフックURLにPOSTリクエストして、ユーザーに通知を送信します。
    -   (**`src/DiscordManager.py`**)

5.  **自動化**:
    -   **GitHub Actions**: `.github/workflows/`内の`schedule_morning.yml`、`schedule_evening.yml`ファイルが、定められた時間にワークフローをトリガーします。
    -   **サーバー (Cron)**: `ubuntu/`ディレクトリのシェルスクリプト（`schedule_morning.sh`など）を使用して、サーバーのCronジョブとして登録し、周期的に実行します。

## プロジェクト構造

-   `.github/workflows/`: GitHub Actionsのためのワークフローファイルが配置されています。
-   `src/`: アプリケーションの主要なソースコードが含まれるメインディレクトリ。
    -   `api.py`: 外部から呼び出すAPI関数を定義します。
    -   `parse/`: ウェブサイトのデータをパーシングするモジュール。
        -   `rate_train_info.py`: 運行情報ページ全体をパーシングして、遅延状況やお知らせ、各列車情報を抽出します。
        -   `train_info.py`: 遅延した個別の列車の詳細情報をパーシングします。
    -   `get_contents.py`: パーシングされたデータをユーザーが読みやすい多言語（ko, en, ja）メッセージに加工・フォーマットします。
    -   `DiscordManager.py`: メッセージをDiscordウェブフックに送信するためのマネージャー。
-   `ubuntu/`: Ubuntuサーバー環境でスクリプトを自動化するためのシェルスクリプトが含まれるディレクトリ。
-   `config.py`: スクレイピング対象のURL、パーシングに必要なキーワードなど、動作に必要な主要な設定値を管理します。
-   `requirements.txt`: プロジェクトの実行に必要なPythonパッケージのリスト。
-   `LICENSE`

## 主なロジックフロー

1.  **実行**: GitHub ActionsのスケジューラやサーバーのCronジョブが、指定された時間に実行スクリプト（`reusable_check.yml`または`reusable_check.py`）を呼び出します。
2.  **API呼び出し**: スクリプトは`src/api.py`に定義された`get_train_status_range_api`のような関数を呼び出してプロセスを開始します。このとき、確認したい駅、方向、言語などのパラメータを渡します。
3.  **HTML収集**: `src/parse/rate_train_info.py`がJRセントラルのウェブサイトに接続し、最新の運行情報が含まれるHTMLページを取得します。
4.  **運行状況確認**: 取得したHTMLを分析して、「正常運転」か「遅延」かをまず判別します。正常運転の場合、通知せずにプロセスを終了します。
5.  **詳細情報パーシング**: 遅延が発生した場合、`BeautifulSoup4`を利用して遅延のお知らせ内容と各列車の情報を抽出します。
6.  **個別列車情報抽出**: `src/parse/train_info.py`が各列車のHTML片から、列車の種類、目的地、現在位置、遅延時間など具体的な情報を抜き出します。
7.  **データフィルタリング**: `src/api.py`は抽出されたすべての列車情報の中から、ユーザーが設定した駅と方向（上り/下り）に該当するものだけを絞り込みます。
8.  **メッセージ生成**: `src/get_contents.py`がフィルタリングされたデータを基に、指定された言語（ko, en, ja）に合わせてDiscordに送信する最終的なメッセージを生成します。
9.  **通知発送**: `src/DiscordManager.py`が生成されたメッセージをDiscordウェブフックURLに送信し、ユーザーに通知を送ります。

## インストールと使用方法

### 事前要件

-   Python 3.x
-   `pip`
-   `git`

### 1. ローカル環境での実行

1.  **プロジェクトのクローンとサブモジュールの初期化**:
    ```bash
    git clone https://github.com/your-username/train_time_check.git
    cd train_time_check
    git submodule update --init --recursive
    ```

2.  **依存関係のインストール**:
    ```bash
    pip install -r requirements.txt
    ```

3.  **環境変数の設定**:
    -   `.env`ファイルをプロジェクトルートに作成し、DiscordウェブフックURLを追加します。
      ```
      WEBHOOK_URL="https://discord.com/api/webhooks/your/webhook_url"
      ```

4.  **テスト実行**:
    -   `src/api.py`ファイルを直接実行して、特定の条件の結果をコンソールで確認できます。
      ```python
      # src/api.pyの末尾にあるテストコードを修正
      result = get_train_status_range_api("刈谷", range_n=6, language="ja", direction="up")
      ...
      ```

### 2. GitHub Actionsによる自動化

1.  **リポジトリのフォーク**: このリポジトリを自身のGitHubアカウントにフォークします。
2.  **Secretsの設定**:
    -   フォークしたリポジトリの`Settings` > `Secrets and variables` > `Actions`に移動します。
    -   `New repository secret`をクリックして、`WEBHOOK_URL`という名前で自身のDiscordウェブフックURLを登録します。
3.  **ワークフローの有効化と修正**:
    -   `.github/workflows/`の`schedule_*.yml`ファイルで、cronスケジュールのコメントを解除し、希望の時間に設定します。
    -   `with`セクションで、`target_station`、`direction`などのパラメータを自身の環境に合わせて修正します。
    -   変更を`main`または`dev`ブランチにプッシュすると、ワークフローが有効になります。

### 3. サーバー（Ubuntu）でのCronによる自動化

1.  **サーバーへのプロジェクトのデプロイ**: ローカル環境と同様に、プロジェクトをクローンして設定します。
2.  **実行スクリプトの修正**: `ubuntu/`ディレクトリの`schedule_morning.sh`、`schedule_evening.sh`ファイルで、`TARGET_STATION`、`DIRECTION`などの変数を設定します。
3.  **Cronジョブの登録**:
    ```bash
    crontab -e
    ```
    -   エディタで以下のようにスケジュールを追加します（例：毎日午前7時30分に実行）。
      ```cron
      30 7 * * 1-5 /path/to/your/project/train_time_check/ubuntu/schedule_morning.sh
      ```

## 注意事項と免責事項
* 本プロジェクトは個人的な学習および便宜のために制作された非公式のオープンソースプロジェクトであり、商用利用は禁止されています。

* データ出所および権利：提供されるすべての列車運行情報の原著作権は、JRセントラル（東海旅客鉄道株式会社）にあります。本プロジェクトは、元データの所有権を主張せず、通知送信後にデータを別途保存しません。

* 負荷防止：ターゲットウェブサイトのサーバーに負荷をかけないよう、適切な実行周期（Cronなど）を設定して使用してください。無分別な短い周期での実行によって発生するIPブロックなどの問題は、使用者自身の責任となります。
  
* 公式APIではなくウェブスクレイピングを活用しているため、対象ウェブサイトの構造が変更された場合、予告なく正常に動作しなくなる可能性があります。提供される情報の100%の正確性やリアルタイム性を保証するものではありません。
