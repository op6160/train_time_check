> **このプロジェクトは純粋な学習目的で制作された非公式プロジェクトであり、商業的な使用を禁止します。提供される情報の正確性は保証されず、いかなる法的責任も負いません。**

# 列車運行情報通知

このプロジェクトは、JR東海の列車運行情報をウェブスクレイピングし、遅延や運休が発生した場合にDiscordに通知を送信する自動化システムです。

## 主な機能

-   **リアルタイム運行情報の確認**：JR東海のウェブサイトをスクレイピングして現在の運行状況を確認します。
-   **遅延情報の解析**：列車の遅延発生時、詳細な遅延情報（影響区間、時間など）と各列車の位置情報を抽出します。
-   **多言語対応**：確認された情報を韓国語、日本語、英語に加工して提供します。
-   **Discord通知**：整形された運行情報を指定のDiscordチャンネルにWebhookを通じて送信します。
-   **自動実行**：GitHub ActionsまたはサーバーのCronジョブを介して、特定の時間（例：通勤・通学時間）に自動的に実行するよう設定できます。
-   **ターゲティング機能**：特定の駅と方向（上り/下り）を基準に、関連する列車情報のみをフィルタリングして通知できます。

## 動作の仕組み

1.  **データ収集（ウェブスクレイピング）**：
    -   `requests`と`BeautifulSoup4`（または`selenium`）を使用して、JR東海の運行情報ページのHTMLを取得します。
    -   （**`src/parse/rate_train_info.py`**）

2.  **情報の解析と分析**：
    -   取得したHTMLを解析し、全体の運行状況が「正常運転」であるかを確認します。
    -   遅延が発生している場合、お知らせの全文と共に、遅延している各列車の種別、目的地、現在位置、遅延時間などの詳細情報を抽出します。
    -   （**`src/parse/train_info.py`**, **`src/parse/rate_train_info.py`**）

3.  **データの処理と加工**：
    -   抽出された生データをフィルタリング（特定の駅、方向を基準に）し、多言語（ko, en, ja）のメッセージに変換します。
    -   （**`src/api.py`**, **`src/get_contents.py`**）

4.  **通知の送信**：
    -   加工されたメッセージをDiscordのWebhook URLにPOSTリクエストとして送信し、通知を行います。
    -   （**`src/DiscordManager.py`**）

5.  **自動化**：
    -   **GitHub Actions**：`.github/workflows/`内の`schedule_morning.yml`、`schedule_evening.yml`ファイルが、定められた時間にワークフローをトリガーします。
    -   **サーバー（Cron）**：`ubuntu/`ディレクトリ内のシェルスクリプト（`schedule_morning.sh`など）を使用して、サーバーのCronジョブとして登録し、定期的に実行します。

## プロジェクトの構造

-   `.github/workflows/`: GitHub Actionsのためのワークフローファイルが配置されています。`schedule_morning.yml`のように、特定時間にスクリプトを実行する役割を担います。
-   `src/`: アプリケーションの核心となるソースコードが格納されているメインディレクトリです。
    -   `api.py`: 全体のプロセスを調整するメインエントリーポイントとして機能します。外部から呼び出すためのAPI関数を定義します。
    -   `parse/`: ウェブサイトのHTMLを解析するモジュール群です。
        -   `rate_train_info.py`: 運行情報ページ全体を解析し、遅延状況、お知らせ、各列車情報を抽出します。
        -   `train_info.py`: 遅延した個別の列車の詳細情報を解析します。
    -   `get_contents.py`: 解析されたデータを、ユーザーが読みやすい多言語（ko, en, ja）メッセージに加工・整形します。
    -   `DiscordManager.py`: 整形されたメッセージをDiscordのWebhookに送信する役割を担当します。
-   `ubuntu/`: Ubuntuサーバー環境でCronジョブとしてスクリプトを実行するためのシェルスクリプト群です。
-   `config.py`: スクレイピング対象のURLや、解析に必要なキーワードなど、主要な設定値を管理します。
-   `requirements.txt`: プロジェクトの実行に必要なPythonパッケージのリストです。
-   `LICENSE`: プロジェクトのオープンソースライセンス（MIT）を明記したファイルです。

## 主なロジックの流れ

1.  **実行 (Trigger)**: GitHub ActionsのスケジューラまたはサーバーのCronジョブが、指定された時間に実行スクリプト（`reusable_check.yml`または`reusable_check.py`）を呼び出します。
2.  **API呼び出し**: スクリプトは`src/api.py`に定義された`get_train_status_range_api`のような関数を呼び出し、プロセスを開始します。その際、確認したい駅、方向、言語などのパラメータを渡します。
3.  **HTML収集**: `src/parse/rate_train_info.py`がJR東海のウェブサイトにアクセスし、最新の運行情報が含まれるHTMLページを取得します。
4.  **運行状況の確認**: 取得したHTMLを分析し、まず「正常運転」か「遅延」かを判別します。正常運転の場合、通知せずにプロセスを終了します。
5.  **詳細情報の解析**: 遅延が発生している場合、`BeautifulSoup4`を利用して遅延のお知らせ内容と各列車の情報を抽出します。
6.  **個別列車情報の抽出**: `src/parse/train_info.py`が、各列車のHTMLスニペットから列車の種別、目的地、現在位置、遅延時間などの具体的な情報を引き出します。
7.  **データフィルタリング**: `src/api.py`は、抽出されたすべての列車情報の中から、ユーザーが設定した駅と方向（上り/下り）に該当するものだけを絞り込みます。
8.  **メッセージ生成**: `src/get_contents.py`が、フィルタリングされたデータを基に、指定された言語（ko, en, ja）に合わせてDiscordに送信する最終的なメッセージを生成します。
9.  **通知送信**: `src/DiscordManager.py`が、生成されたメッセージをDiscordのWebhook URLに送信し、ユーザーに通知します。

## インストールと使用方法

### 事前要件

-   Python 3.x
-   `pip`
-   `git`

### 1. ローカル環境での実行

1.  **プロジェクトのクローンとサブモジュールの初期化**：
    ```bash
    git clone https://github.com/your-username/train_time_check.git
    cd train_time_check
    git submodule update --init --recursive
    ```

2.  **依存関係のインストール**：
    ```bash
    pip install -r requirements.txt
    ```

3.  **環境変数の設定**：
    -   プロジェクトのルートに`.env`ファイルを作成し、DiscordのWebhook URLを追加します。
      ```
      WEBHOOK_URL="https://discord.com/api/webhooks/your/webhook_url"
      ```

4.  **テスト実行**：
    -   `src/api.py`ファイルを直接実行することで、特定の条件下での結果をコンソールで確認できます。
      ```python
      # src/api.pyの末尾にあるテストコードを修正
      result = get_train_status_range_api("金山", range_n=6, language="ja", direction="down")
      ...
      ```

### 2. GitHub Actionsによる自動化

1.  **リポジトリのフォーク**：このリポジトリを自身のGitHubアカウントにフォークします。
2.  **Secretsの設定**：
    -   フォークしたリポジトリの`Settings` > `Secrets and variables` > `Actions`に移動します。
    -   `New repository secret`をクリックし、`WEBHOOK_URL`という名前で自身のDiscord Webhook URLを登録します。
3.  **ワークフローの有効化と修正**：
    -   `.github/workflows/`内の`schedule_*.yml`ファイルで、cronスケジュールのコメントを解除し、希望の時間に設定します。
    -   `with`セクションで`target_station`、`direction`などのパラメータを自身の環境に合わせて修正します。
    -   変更を`main`または`dev`ブランチにプッシュすると、ワークフローが有効になります。

### 3. サーバー（Ubuntu）でのCronによる自動化

1.  **サーバーへのプロジェクトのデプロイ**：ローカル環境と同様に、プロジェクトをクローンして設定します。
2.  **実行スクリプトの修正**：`ubuntu/`ディレクトリの`schedule_morning.sh`、`schedule_evening.sh`ファイルで、`TARGET_STATION`、`DIRECTION`などの変数を設定します。
3.  **Cronジョブの登録**：
    ```bash
    crontab -e
    ```
    -   エディタで以下のようにスケジュールを追加します（例：毎日午前7時30分に実行）。
      ```cron
      30 7 * * 1-5 /path/to/your/project/train_time_check/ubuntu/schedule_morning.sh
      ```

## 免責事項および著作権表示

-   **データ出所と著作権**: このプロジェクトで提供されるすべての情報の元のデータおよびコンテンツの著作権は、**JR東海（東海旅客鉄道株式会社）**に帰属します。本プロジェクトはデータの所有権を主張しません。
-   **非公式プロジェクト**: 本プロジェクトは、JR東海と提携、保証、またはその他の公式な関係を持たない、**純粋な学習目的の非公式プロジェクト**です。
-   **非営利的使用**: 本プロジェクトは非営利的な（Non-commercial）目的でのみ使用されるべきであり、いかなる形態の営利目的での使用も固く禁じます。
-   **データの非保存**: このアプリケーションは、スクレイピングしたデータを外部サーバーやファイルに保存しません。情報は通知送信の目的でのみ一時的にメモリ上で処理され、プロセス終了時に即座に破棄されます。
-   **情報の限界と責任**: 本プロジェクトは公式APIではなく、ウェブスクレイピング技術に依存しているため、元のウェブサイトの構造が変更された場合、予告なく機能が停止することがあります。提供される情報の完全な正確性やリアルタイム性を保証するものではありません。開発者は、その使用によって生じるいかなる直接的・間接的な損害に対しても法的責任を負いません。
-   **スクレイピングに関する責任**: 利用者は、本プロジェクトを使用することにより、JR東海のウェブサイトに過度な負荷をかけず、ウェブサイトの利用規約（Terms of Service）を尊重する責任を負います。本プロジェクトの使用によって生じるすべての法的問題（データ提供元の権利侵害を含むがこれに限定されない）の責任は、全面的に利用者に帰属します。
